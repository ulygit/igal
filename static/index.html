<!DOCTYPE html>
<html>
  <head>
    <title>Photo Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      h1 {
        text-align: center;
      }

      form {
        max-width: 500px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f2f2f2;
        border-radius: 5px;
      }

      input[type="file"], input[type="text"], input[type="submit"] {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
        font-size: 16px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-size: 16px;
      }

      #progress {
        margin-top: 20px;
      }

      .progress-item {
        margin-bottom: 5px;
      }

      @media (max-width: 480px) {
        form {
          padding: 10px;
        }

        input[type="file"], input[type="text"], input[type="submit"] {
          font-size: 14px;
        }

        label {
          font-size: 14px;
        }
      }
    </style>
    <script>
      function uploadFiles(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const uploadButton = document.getElementById('upload-button');
        const progressDiv = document.getElementById('progress');
        const stripMetadataCheckbox = document.getElementById('strip-metadata');

        uploadButton.disabled = true;
        progressDiv.textContent = 'Uploading...';

        const fileInput = document.getElementById('file-input');
        const files = fileInput.files;

        uploadNextFile(files, 0, formData, stripMetadataCheckbox.checked);
      }

      function uploadNextFile(files, index, formData, stripMetadata) {
        if (index >= files.length) {
          document.getElementById('progress').textContent = 'Upload complete!';
          document.getElementById('upload-button').disabled = false; // Enable the upload button
          return;
        }

        const file = files[index];
        const fileEntry = formData.get('photos');
        const subdirectory = formData.get('subdirectory');

        if (stripMetadata) {
          stripMetadataAndUpload(file, subdirectory, formData)
            .then(() => {
              const progressDiv = document.getElementById('progress');
              progressDiv.textContent = `Uploaded ${file.name}`;
              uploadNextFile(files, index + 1, formData, stripMetadata);
            })
            .catch(error => {
              console.error('Error:', error);
            });
        } else {
          uploadFile(file, subdirectory, formData)
            .then(() => {
              const progressDiv = document.getElementById('progress');
              progressDiv.textContent = `Uploaded ${file.name}`;
              uploadNextFile(files, index + 1, formData, stripMetadata);
            })
            .catch(error => {
              console.error('Error:', error);
            });
        }
      }

      function stripMetadataAndUpload(file, subdirectory, formData) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.src = reader.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const dataURL = canvas.toDataURL('image/jpeg');
              const blobData = dataURIToBlob(dataURL);

              const uploadFormData = new FormData();
              uploadFormData.append('photo', blobData, file.name);
              if (subdirectory) {
                uploadFormData.append('subdirectory', subdirectory);
              }

              fetch('/upload', {
                method: 'POST',
                body: uploadFormData
              })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    resolve();
                  } else {
                    reject(new Error(data.message));
                  }
                })
                .catch(error => reject(error));
            };
          };
          reader.readAsDataURL(file);
        });
      }

      function uploadFile(file, subdirectory, formData) {
        return new Promise((resolve, reject) => {
          const uploadFormData = new FormData();
          uploadFormData.append('photo', file, file.name);
          if (subdirectory) {
            uploadFormData.append('subdirectory', subdirectory);
          }

          fetch('/upload', {
            method: 'POST',
            body: uploadFormData
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                resolve();
              } else {
                reject(new Error(data.message));
              }
            })
            .catch(error => reject(error));
        });
      }

      function dataURIToBlob(dataURI) {
        const byteString = atob(dataURI.split(',')[1]);
        const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeString });
      }
    </script>
  </head>
  <body>
    <h1>Upload Photos</h1>
    <form onsubmit="uploadFiles(event)">
      <label for="file-input">Select files:</label>
      <input type="file" id="file-input" name="photos" accept="image/*" multiple required>
      <br>
      <label>
        <input type="checkbox" id="strip-metadata" name="strip_metadata" value="true">
        Strip metadata
      </label>
      <br>
      <label for="subdirectory">Subdirectory (optional):</label>
      <input type="text" id="subdirectory" name="subdirectory">
      <br>
      <input type="submit" id="upload-button" value="Upload">
    </form>
    <div id="progress"></div>
  </body>
</html>
