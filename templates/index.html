<!DOCTYPE html>
<html>
  <head>
    <title>pantr - fast photo sharing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background-color: #342e21;
    color: #E3D8CF;
    font-size: 20px;
  }

  h1 {
    text-align: center;
    font-size: 60px;
    margin-bottom: 0px;
    color: #C6A680;
  }

  h2 {
    text-align: center;
    font-size: 14px;
    color: #817056;
  }

  form {
    max-width: 625px;
    margin: 0 auto;
    padding: 25px;
    border-radius: 5px;
  }

  input[type="text"] {
    display: block;
    width: 100%;
    padding: 12.5px;
    margin-bottom: 12.5px;
    box-sizing: border-box;
    font-size: 20px;
    background-color: #765F41;
    color: #E3D8CF;
    border: 1px solid #817056;
  }

  input[type="submit"] {
    display: block;
    width: auto;
    padding: 12.5px 25px;
    margin: 20px auto 0;
    font-size: 20px;
    background-color: #C6A680;
    color: #334E60;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  input[type="submit"]:hover {
    background-color: #E3D8CF;
  }

  input[type="submit"]:disabled {
    background-color: #765F41;
    color: #817056;
    cursor: not-allowed;
  }

  label {
    display: block;
    margin-bottom: 6.25px;
    font-size: 20px;
    color: #C6A680;
  }

  #progress, #error, #gallery-link {
    margin-top: 25px;
  }

  .progress-item {
    margin-bottom: 6.25px;
  }

  #error {
    color: #C6A680;
  }

  #gallery-link {
    font-weight: bold;
  }

  #gallery-link a {
    color: #C6A680;
  }

  .version-id {
    position: fixed;
    bottom: 6.25px;
    right: 6.25px;
    font-size: 12px;
    color: #817056;
  }

  input[type="checkbox"] {
    width: 20px;
    height: 20px;
  }

  .file-input-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    background-color: #765F41;
    border: 2px dashed #C6A680;
    border-radius: 5px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    width: 100%;
    box-sizing: border-box;
  }

  .file-input-wrapper:hover {
    background-color: #817056;
  }

  .file-input-wrapper input[type=file] {
    font-size: 100px;
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    cursor: pointer;
  }

  .file-input-icon {
    width: 64px;
    height: 64px;
    margin-bottom: 10px;
    filter: invert(1);
  }

  .file-input-text {
    font-size: 18px;
    color: #E3D8CF;
  }

  @media (max-width: 480px) {
    form {
      padding: 12.5px;
    }

    input[type="text"], input[type="submit"] {
      font-size: 17.5px;
    }

    label {
      font-size: 17.5px;
    }

    .file-input-text {
      font-size: 16px;
    }
  }
</style>
    <script>
      async function checkGallery(gallery) {
        const response = await fetch(`/check_gallery/${gallery}`);
        return response.json();
      }

      async function uploadFiles(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const uploadButton = document.getElementById('upload-button');
        const progressDiv = document.getElementById('progress');
        const errorDiv = document.getElementById('error');
        const galleryLinkDiv = document.getElementById('gallery-link');
        const stripMetadataCheckbox = document.getElementById('strip-metadata');
        const gallery = formData.get('gallery');

        // Clear progress, error, and gallery link texts
        progressDiv.textContent = '';
        errorDiv.textContent = '';
        galleryLinkDiv.textContent = '';

        if (!gallery) {
          errorDiv.textContent = 'Please enter a gallery name.';
          return;
        }

        const galleryExists = await checkGallery(gallery);
        if (galleryExists.exists) {
          errorDiv.textContent = 'This gallery already exists. Please use a different name.';
          return;
        }

        uploadButton.disabled = true;
        progressDiv.textContent = 'Uploading...';

        const fileInput = document.getElementById('file-input');
        const files = fileInput.files;

        try {
          await uploadNextFile(files, 0, formData, stripMetadataCheckbox.checked);
          progressDiv.textContent = 'Upload complete!';
          galleryLinkDiv.innerHTML = `<a href="/i/${gallery}" target="_blank">View Gallery</a>`;
        } catch (error) {
          errorDiv.textContent = `Error: ${error.message}`;
        } finally {
          uploadButton.disabled = false;
        }
      }

      async function uploadNextFile(files, index, formData, stripMetadata) {
        if (index >= files.length) {
          return;
        }

        const file = files[index];
        const gallery = formData.get('gallery');

        if (stripMetadata) {
          await stripMetadataAndUpload(file, gallery, formData);
        } else {
          await uploadFile(file, gallery, formData);
        }

        const progressDiv = document.getElementById('progress');
        progressDiv.textContent = `Uploaded ${file.name}`;
        await uploadNextFile(files, index + 1, formData, stripMetadata);
      }

      function stripMetadataAndUpload(file, gallery, formData) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.src = reader.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const dataURL = canvas.toDataURL('image/jpeg');
              const blobData = dataURIToBlob(dataURL);

              const uploadFormData = new FormData();
              uploadFormData.append('photo', blobData, file.name);
              if (gallery) {
                uploadFormData.append('gallery', gallery);
              }

              fetch('/upload', {
                method: 'POST',
                body: uploadFormData
              })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    resolve();
                  } else {
                    reject(new Error(data.message));
                  }
                })
                .catch(error => reject(error));
            };
          };
          reader.readAsDataURL(file);
        });
      }

      function uploadFile(file, gallery, formData) {
        return new Promise((resolve, reject) => {
          const uploadFormData = new FormData();
          uploadFormData.append('photo', file, file.name);
          if (gallery) {
            uploadFormData.append('gallery', gallery);
          }

          fetch('/upload', {
            method: 'POST',
            body: uploadFormData
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                resolve();
              } else {
                reject(new Error(data.message));
              }
            })
            .catch(error => reject(error));
        });
      }

      function dataURIToBlob(dataURI) {
        const byteString = atob(dataURI.split(',')[1]);
        const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeString });
      }
    </script>
  </head>
  <body>
		<h1>pantr</h1>
		<h2>fast photo sharing</h2>
    <form onsubmit="uploadFiles(event)">
      <div class="file-input-wrapper">
        <input type="file" id="file-input" name="photos" accept="image/*" multiple required>
        <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIFVwbG9hZGVkIHRvOiBTVkcgUmVwbywgd3d3LnN2Z3JlcG8uY29tLCBHZW5lcmF0b3I6IFNWRyBSZXBvIE1peGVyIFRvb2xzIC0tPgo8c3ZnIGhlaWdodD0iODAwcHgiIHdpZHRoPSI4MDBweCIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiAKCSB2aWV3Qm94PSIwIDAgMTg0LjY5IDE4NC42OSIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxnPgoJPGc+CgkJPGc+CgkJCTxwYXRoIHN0eWxlPSJmaWxsOiMwMDdiZmY7IiBkPSJNMTQ5Ljk2OCw1MC4xODZjLTguMDE3LTE0LjMwOC0yMy43OTYtMjIuNTE1LTQwLjcxNy0xOS44MTMKCQkJCUMxMDIuNjA5LDE2LjQzLDg4LjcxMyw3LjU3Niw3My4wODcsNy41NzZjLTIyLjExNywwLTQwLjExMiwxNy45OTQtNDAuMTEyLDQwLjExNWMwLDAuOTEzLDAuMDM2LDEuODU0LDAuMTE4LDIuODM0CgkJCQlDMTQuMDA0LDU0Ljg3NSwwLDcyLjExLDAsOTEuOTU5YzAsMjMuNDU2LDE5LjA4Miw0Mi41MzUsNDIuNTM4LDQyLjUzNWgzMy42MjN2LTcuMDI1SDQyLjUzOAoJCQkJYy0xOS41ODMsMC0zNS41MDktMTUuOTI5LTM1LjUwOS0zNS41MDljMC0xNy41MjYsMTMuMDg0LTMyLjYyMSwzMC40NDItMzUuMTA1YzAuOTMxLTAuMTMyLDEuNzY4LTAuNjMzLDIuMzI2LTEuMzkyCgkJCQljMC41NTUtMC43NTUsMC43OTUtMS43MDQsMC42NDQtMi42M2MtMC4yOTctMS45MDQtMC40NDctMy41ODItMC40NDctNS4xMzljMC0xOC4yNDksMTQuODUyLTMzLjA5NCwzMy4wOTQtMzMuMDk0CgkJCQljMTMuNzAzLDAsMjUuNzg5LDguMjYsMzAuODAzLDIxLjA0YzAuNjMsMS42MjEsMi4zNTEsMi41MzQsNC4wNTgsMi4xNGMxNS40MjUtMy41NjgsMjkuOTE5LDMuODgzLDM2LjYwNCwxNy4xNjgKCQkJCWMwLjUwOCwxLjAyNywxLjUwMywxLjczNiwyLjY0MSwxLjg5N2MxNy4zNjgsMi40NzMsMzAuNDgxLDE3LjU2OSwzMC40ODEsMzUuMTEyYzAsMTkuNTgtMTUuOTM3LDM1LjUwOS0zNS41MiwzNS41MDlIOTcuMzkxCgkJCQl2Ny4wMjVoNDQuNzYxYzIzLjQ1OSwwLDQyLjUzOC0xOS4wNzksNDIuNTM4LTQyLjUzNUMxODQuNjksNzEuNTQ1LDE2OS44ODQsNTMuOTAxLDE0OS45NjgsNTAuMTg2eiIvPgoJCTwvZz4KCQk8Zz4KCQkJPHBhdGggc3R5bGU9ImZpbGw6IzAwN2JmZjsiIGQ9Ik0xMDguNTg2LDkwLjIwMWMxLjQwNi0xLjQwMywxLjQwNi0zLjY3MiwwLTUuMDc1TDg4LjU0MSw2NS4wNzgKCQkJCWMtMC43MDEtMC42OTgtMS42MTQtMS4wNDUtMi41MzQtMS4wNDVsLTAuMDY0LDAuMDExYy0wLjAxOCwwLTAuMDM2LTAuMDExLTAuMDU0LTAuMDExYy0wLjkzMSwwLTEuODUsMC4zNjEtMi41MzQsMS4wNDUKCQkJCUw2My4zMSw4NS4xMjdjLTEuNDAzLDEuNDAzLTEuNDAzLDMuNjcyLDAsNS4wNzVjMS40MDMsMS40MDYsMy42NzIsMS40MDYsNS4wNzUsMEw4Mi4yOTYsNzYuMjl2OTcuMjI3CgkJCQljMCwxLjk5LDEuNjAzLDMuNTk3LDMuNTkzLDMuNTk3YzEuOTc5LDAsMy41OS0xLjYwNywzLjU5LTMuNTk3Vjc2LjE2NWwxNC4wMzMsMTQuMDM2CgkJCQlDMTA0LjkxLDkxLjYwOCwxMDcuMTgzLDkxLjYwOCwxMDguNTg2LDkwLjIwMXoiLz4KCQk8L2c+Cgk8L2c+CjwvZz4KPC9zdmc+Cg==" alt="Upload icon" class="file-input-icon">
        <div class="file-input-text">Click to choose files</div>
      </div>
      <br>
      <label>
        <input type="checkbox" id="strip-metadata" name="strip_metadata" value="true" checked>
        Remove hidden information (e.g. location data and camera settings)
      </label>
      <br>
      <label for="gallery">Gallery name (required):</label>
      <input type="text" id="gallery" name="gallery" required>
      <br>
      <input type="submit" id="upload-button" value="Upload">
    </form>
    <div id="error"></div>
    <div id="progress"></div>
    <div id="gallery-link"></div>
    <div class="version-id">version: {{ version_id }}</div>
  </body>
</html>
