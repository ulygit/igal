<!DOCTYPE html>
<html>
  <head>
    <title>pantr - fast photo sharing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}" type="text/css">
    <style>
      form {
        max-width: 625px;
        margin: 0 auto;
        padding: 25px;
        border-radius: 5px;
      }
    
      input[type="text"] {
        display: block;
        width: 100%;
        padding: 12.5px;
        margin-bottom: 12.5px;
        box-sizing: border-box;
        font-size: 20px;
        background-color: #765F41;
        color: #E3D8CF;
        border: 1px solid #817056;
      }
    
      input[type="text"]:focus-within {
        outline: 2px solid #334e60;
      }
    
      input[type="submit"] {
        display: block;
        width: auto;
        padding: 12.5px 25px;
        margin: 20px auto 0;
      }
    
      label {
        display: block;
        margin-bottom: 6.25px;
        font-size: 20px;
        color: #C6A680;
      }
    
      #progress, #error, #gallery-link {
        margin-top: 25px;
      }
    
      .progress-item {
        margin-bottom: 6.25px;
      }
    
      #error {
        color: #C6A680;
      }
    
      #gallery-link {
        font-weight: bold;
      }
    
      #gallery-link a {
        color: #C6A680;
      }
    
      .file-input-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        background-color: #765F41;
        border: 2px dashed #C6A680;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        width: 100%;
        box-sizing: border-box;
      }
    
      .file-input-wrapper:hover {
        background-color: #817056;
      }
    
      .file-input-wrapper input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
      }
    
      .file-input-icon {
        width: 64px;
        height: 64px;
        margin-bottom: 10px;
      }
    
      .file-input-text {
        font-size: 18px;
        color: #E3D8CF;
      }
    
    .selected-images {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
    }
    
    .selected-image-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin: 5px;
      border: 2px solid #C6A680;
    }
    
    .additional-images-count {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      background-color: #C6A680;
      color: #334E60;
      font-weight: bold;
      margin: 5px;
      border-radius: 5px;
    }
    
      @media (max-width: 480px) {
        form {
          padding: 12.5px;
        }
    
        input[type="text"], input[type="submit"] {
          font-size: 17.5px;
        }
    
        label {
          font-size: 17.5px;
        }
    
        .file-input-text {
          font-size: 16px;
        }
      }
    </style>
    <script>
      async function checkGallery(gallery) {
        const response = await fetch(`/check_gallery/${gallery}`);
        return response.json();
      }

      async function uploadFiles(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const uploadButton = document.getElementById('upload-button');
        const progressDiv = document.getElementById('progress');
        const errorDiv = document.getElementById('error');
        const galleryLinkDiv = document.getElementById('gallery-link');
        const stripMetadataCheckbox = document.getElementById('strip-metadata');
        const gallery = formData.get('gallery');

        // Clear progress, error, and gallery link texts
        progressDiv.textContent = '';
        errorDiv.textContent = '';
        galleryLinkDiv.textContent = '';

        if (!gallery) {
          errorDiv.textContent = 'Please enter a gallery name.';
          return;
        }

        const galleryExists = await checkGallery(gallery);
        if (galleryExists.exists) {
          errorDiv.textContent = 'This gallery already exists. Please use a different name.';
          return;
        }

        uploadButton.disabled = true;
        progressDiv.textContent = 'Uploading...';

        const fileInput = document.getElementById('file-input');
        const files = fileInput.files;

        try {
          await uploadNextFile(files, 0, formData, stripMetadataCheckbox.checked);
          progressDiv.textContent = 'Upload complete!';
          galleryLinkDiv.innerHTML = `<a href="/i/${gallery}" target="_blank">View Gallery</a>`;
        } catch (error) {
          errorDiv.textContent = `Error: ${error.message}`;
        } finally {
          uploadButton.disabled = false;
        }
      }

      async function uploadNextFile(files, index, formData, stripMetadata) {
        if (index >= files.length) {
          return;
        }

        const file = files[index];
        const gallery = formData.get('gallery');

        if (stripMetadata) {
          await stripMetadataAndUpload(file, gallery, formData);
        } else {
          await uploadFile(file, gallery, formData);
        }

        const progressDiv = document.getElementById('progress');
        progressDiv.textContent = `Uploaded ${file.name}`;
        await uploadNextFile(files, index + 1, formData, stripMetadata);
      }

      function stripMetadataAndUpload(file, gallery, formData) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.src = reader.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const dataURL = canvas.toDataURL('image/jpeg');
              const blobData = dataURIToBlob(dataURL);

              const uploadFormData = new FormData();
              uploadFormData.append('photo', blobData, file.name);
              if (gallery) {
                uploadFormData.append('gallery', gallery);
              }

              fetch('/upload', {
                method: 'POST',
                body: uploadFormData
              })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    resolve();
                  } else {
                    reject(new Error(data.message));
                  }
                })
                .catch(error => reject(error));
            };
          };
          reader.readAsDataURL(file);
        });
      }

      function uploadFile(file, gallery, formData) {
        return new Promise((resolve, reject) => {
          const uploadFormData = new FormData();
          uploadFormData.append('photo', file, file.name);
          if (gallery) {
            uploadFormData.append('gallery', gallery);
          }

          fetch('/upload', {
            method: 'POST',
            body: uploadFormData
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                resolve();
              } else {
                reject(new Error(data.message));
              }
            })
            .catch(error => reject(error));
        });
      }

      function dataURIToBlob(dataURI) {
        const byteString = atob(dataURI.split(',')[1]);
        const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeString });
      }
    </script>
  </head>
  <body>
    <h1>pantr</h1>
    <h2>fast photo sharing</h2>
    <form onsubmit="uploadFiles(event)">
      <div class="file-input-wrapper">
        <input type="file" id="file-input" name="photos" accept="image/*" multiple required>
        <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB2aWV3Qm94PSIwIDAgMTkgMTUiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTSA5LjUwNyAxNC41IEwgOS41MDcgNy41IE0gOS41MDcgNy41IEwgNy4yNTcgOS44MzQgTSA5LjUwNyA3LjUgTCAxMS43NTcgOS44MzQgTSA0LjEwNyAxMy4zMzQgQyAyLjExOSAxMy4zMzQgMC41MDcgMTEuNjkyIDAuNTA3IDkuNjY3IEMgMC41MDcgNy45OTggMS42MDEgNi41OSAzLjA5OSA2LjE0NiBDIDMuMTYzIDYuMTI3IDMuMjA3IDYuMDY4IDMuMjA3IDYgQyAzLjIwNyAyLjk2MyA1LjYyNSAwLjUgOC42MDcgMC41IEMgMTEuNTg5IDAuNSAxNC4wMDcgMi45NjMgMTQuMDA3IDYgQyAxNC4wMDcgNi4wNTkgMTQuMDYxIDYuMTAyIDE0LjExNiA2LjA4OSBDIDE0LjM3MSA2LjAzMSAxNC42MzUgNiAxNC45MDcgNiBDIDE2Ljg5NSA2IDE4LjUwNyA3LjY0MiAxOC41MDcgOS42NjcgQyAxOC41MDcgMTEuNjkyIDE2Ljg5NSAxMy4zMzQgMTQuOTA3IDEzLjMzNCIgc3Ryb2tlPSIjMzM0ZTYwIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIHRyYW5zZm9ybT0ibWF0cml4KDEsIDAsIDAsIDEsIDAsIC0xLjc3NjM1NjgzOTQwMDI1MDVlLTE1KSIvPgo8L3N2Zz4K" alt="Upload icon" class="file-input-icon">
        <div class="file-input-text">Click to choose files</div>
        <div id="selected-images" class="selected-images"></div>
      </div>
      <br>
      <label>
        <input type="checkbox" id="strip-metadata" name="strip_metadata" value="true" checked>
        Remove hidden information (e.g. location)
      </label>
      <br>
      <label for="gallery">Gallery name (required):</label>
      <input type="text" id="gallery" name="gallery" required>
      <br>
      <input type="submit" id="upload-button" value="Upload">
    </form>
    <div id="error"></div>
    <div id="progress"></div>
    <div id="gallery-link"></div>
    <div class="version-id">version: {{ version_id }}</div>
  </body>

  <script>
      function handleFileSelect(event) {
        const files = event.target.files;
        const selectedImagesDiv = document.getElementById('selected-images');
        selectedImagesDiv.innerHTML = '';

        if (files.length > 0) {
          const thumbnailSize = 74; // 60px + 5px margin on each side + 2px border on each side
          const containerWidth = selectedImagesDiv.offsetWidth;
          const maxThumbnails = Math.floor(containerWidth / thumbnailSize);
          const imagesToDisplay = files.length <= maxThumbnails ? files.length : maxThumbnails - 1;

          for (let i = 0; i < imagesToDisplay; i++) {
            const file = files[i];
            const reader = new FileReader();

            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              img.classList.add('selected-image-thumbnail');
              selectedImagesDiv.appendChild(img);
            }

            reader.readAsDataURL(file);
          }

          if (files.length > imagesToDisplay) {
            const additionalCount = document.createElement('div');
            additionalCount.classList.add('additional-images-count');
            additionalCount.textContent = `+${files.length - imagesToDisplay}`;
            selectedImagesDiv.appendChild(additionalCount);
          }
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('file-input').addEventListener('change', handleFileSelect);
        document.getElementById('selected-images').addEventListener('click', function(){
          document.getElementById('file-input').click()
        });
      });
  </script>
</html>
