<!DOCTYPE html>
<html>
  <head>
    <title>Photo Upload</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }

      h1 {
        text-align: center;
      }

      form {
        max-width: 500px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f2f2f2;
        border-radius: 5px;
      }

      input[type="file"], input[type="text"], input[type="submit"] {
        display: block;
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
        font-size: 16px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-size: 16px;
      }
      #progress, #error, #gallery-link {
        margin-top: 20px;
      }

      .progress-item {
        margin-bottom: 5px;
      }
      #error {
        color: red;
      }
      #gallery-link {
        font-weight: bold;
      }
      @media (max-width: 480px) {
        form {
          padding: 10px;
        }

        input[type="file"], input[type="text"], input[type="submit"] {
          font-size: 14px;
        }

        label {
          font-size: 14px;
        }
      }
      .version-id {
        position: fixed;
        bottom: 5px;
        right: 5px;
        font-size: 12px;
        color: #888;
      }
    </style>
    <script>
      async function checkGallery(gallery) {
        const response = await fetch(`/check_gallery/${gallery}`);
        return response.json();
      }

      async function uploadFiles(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const uploadButton = document.getElementById('upload-button');
        const progressDiv = document.getElementById('progress');
        const errorDiv = document.getElementById('error');
        const galleryLinkDiv = document.getElementById('gallery-link');
        const stripMetadataCheckbox = document.getElementById('strip-metadata');
        const gallery = formData.get('gallery');

        // Clear progress, error, and gallery link texts
        progressDiv.textContent = '';
        errorDiv.textContent = '';
        galleryLinkDiv.textContent = '';

        if (!gallery) {
          errorDiv.textContent = 'Please enter a gallery name.';
          return;
        }

        const galleryExists = await checkGallery(gallery);
        if (galleryExists.exists) {
          errorDiv.textContent = 'This gallery already exists. Please use a different name.';
          return;
        }

        uploadButton.disabled = true;
        progressDiv.textContent = 'Uploading...';

        const fileInput = document.getElementById('file-input');
        const files = fileInput.files;

        try {
          await uploadNextFile(files, 0, formData, stripMetadataCheckbox.checked);
          progressDiv.textContent = 'Upload complete!';
          galleryLinkDiv.innerHTML = `<a href="/i/${gallery}" target="_blank">View Gallery</a>`;
        } catch (error) {
          errorDiv.textContent = `Error: ${error.message}`;
        } finally {
          uploadButton.disabled = false;
        }
      }

      async function uploadNextFile(files, index, formData, stripMetadata) {
        if (index >= files.length) {
          return;
        }

        const file = files[index];
        const gallery = formData.get('gallery');

        if (stripMetadata) {
          await stripMetadataAndUpload(file, gallery, formData);
        } else {
          await uploadFile(file, gallery, formData);
        }

        const progressDiv = document.getElementById('progress');
        progressDiv.textContent = `Uploaded ${file.name}`;
        await uploadNextFile(files, index + 1, formData, stripMetadata);
      }

      function stripMetadataAndUpload(file, gallery, formData) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            const img = new Image();
            img.src = reader.result;
            img.onload = () => {
              const canvas = document.createElement('canvas');
              canvas.width = img.width;
              canvas.height = img.height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0);
              const dataURL = canvas.toDataURL('image/jpeg');
              const blobData = dataURIToBlob(dataURL);

              const uploadFormData = new FormData();
              uploadFormData.append('photo', blobData, file.name);
              if (gallery) {
                uploadFormData.append('gallery', gallery);
              }

              fetch('/upload', {
                method: 'POST',
                body: uploadFormData
              })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    resolve();
                  } else {
                    reject(new Error(data.message));
                  }
                })
                .catch(error => reject(error));
            };
          };
          reader.readAsDataURL(file);
        });
      }

      function uploadFile(file, gallery, formData) {
        return new Promise((resolve, reject) => {
          const uploadFormData = new FormData();
          uploadFormData.append('photo', file, file.name);
          if (gallery) {
            uploadFormData.append('gallery', gallery);
          }

          fetch('/upload', {
            method: 'POST',
            body: uploadFormData
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'success') {
                resolve();
              } else {
                reject(new Error(data.message));
              }
            })
            .catch(error => reject(error));
        });
      }

      function dataURIToBlob(dataURI) {
        const byteString = atob(dataURI.split(',')[1]);
        const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        const ab = new ArrayBuffer(byteString.length);
        const ia = new Uint8Array(ab);
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
        }
        return new Blob([ab], { type: mimeString });
      }
    </script>
  </head>
  <body>
    <h1>Upload Photos</h1>
    <form onsubmit="uploadFiles(event)">
      <label for="file-input">Select files:</label>
      <input type="file" id="file-input" name="photos" accept="image/*" multiple required>
      <br>
      <label>
        <input type="checkbox" id="strip-metadata" name="strip_metadata" value="true" checked>
        Strip metadata
      </label>
      <br>
      <label for="gallery">Gallery name (required):</label>
      <input type="text" id="gallery" name="gallery" required>
      <br>
      <input type="submit" id="upload-button" value="Upload">
    </form>
    <div id="error"></div>
    <div id="progress"></div>
    <div id="gallery-link"></div>
    <div class="version-id">Version: {{ version_id }}</div>
  </body>
</html>
